name: Deploy to AWS

on:
  workflow_dispatch:
    inputs:
      deploy-mode:
        description: 'Deploy mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - data-only

permissions:
  contents: read
  id-token: write

jobs:
  deploy-full:
    if: inputs.deploy-mode == 'full'
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸš€ Deploy AWS (Full) â€” Build site and deploy to S3 + CloudFront'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  DEPLOY TO AWS â€” FULL                                      â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•‘  Builds the complete Nuxt static site from committed       â•‘"
          echo "â•‘  exports and deploys to S3. Invalidates CloudFront cache   â•‘"
          echo "â•‘  if configured.                                            â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•‘  Trigger: manual (workflow_dispatch)                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build site
        run: pnpm build:site
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
          NUXT_PUBLIC_GITHUB_REPO: ${{ vars.GH_REPO_SLUG }}
          NUXT_PUBLIC_GITHUB_BRANCH: ${{ vars.GH_BRANCH || 'main' }}
          NUXT_PUBLIC_GITHUB_VOCAB_PATH: ${{ vars.GH_VOCAB_PATH || 'web/public/sample-data/vocabs' }}
          NUXT_PUBLIC_GITHUB_CLIENT_ID: ${{ vars.GH_CLIENT_ID }}
          NUXT_PUBLIC_GITHUB_AUTH_WORKER_URL: ${{ vars.GH_AUTH_WORKER_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-southeast-2

      - name: Deploy to S3
        run: |
          echo "Syncing to s3://${{ vars.DEV_BUCKET_NAME }}/ ..."
          aws s3 sync web/.output/public/ "s3://${{ vars.DEV_BUCKET_NAME }}/" --delete --quiet
          echo "âœ“ Deploy complete"

      - name: Invalidate CloudFront cache
        if: vars.DEV_CDN_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ vars.DEV_CDN_ID }}" \
            --paths "/*"

  deploy-data-only:
    if: inputs.deploy-mode == 'data-only'
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸ“¦ Deploy AWS (Data Only) â€” Sync exports to S3'
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  DEPLOY TO AWS â€” DATA ONLY                                 â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•‘  Syncs committed export files directly to S3 without       â•‘"
          echo "â•‘  rebuilding the site. Use when only vocabulary data has     â•‘"
          echo "â•‘  changed.                                                  â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•‘  Trigger: manual (workflow_dispatch)                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-southeast-2

      - name: Sync exports to S3
        run: |
          echo "Syncing exports to s3://${{ vars.DEV_BUCKET_NAME }}/export/ ..."
          aws s3 sync web/public/export/ "s3://${{ vars.DEV_BUCKET_NAME }}/export/" --delete --quiet
          echo "âœ“ Export sync complete"

      - name: Invalidate CloudFront cache
        if: vars.DEV_CDN_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ vars.DEV_CDN_ID }}" \
            --paths "/export/*"
