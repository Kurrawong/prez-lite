name: Build and Deploy Prez Lite Site

on:
  workflow_call:
    inputs:
      prez-lite-version:
        description: 'prez-lite version, branch, or tag (e.g. v0.2.0, main)'
        type: string
        default: 'main'
      node-version:
        description: 'Node.js version'
        type: string
        default: '22'
    secrets:
      prez-lite-token:
        description: 'GitHub PAT for accessing prez-lite repo (required if private)'
        required: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Fetch data-processing from prez-lite
        env:
          GITHUB_TOKEN: ${{ secrets.prez-lite-token }}
          PREZ_LITE_REPO: ${{ vars.PREZ_LITE_REPO || 'hjohns/prez-lite' }}
          PREZ_LITE_VERSION: ${{ inputs.prez-lite-version }}
        run: |
          mkdir -p .prez-lite-cache

          # Build clone URL (with or without token)
          if [ -n "$GITHUB_TOKEN" ]; then
            CLONE_URL="https://${GITHUB_TOKEN}@github.com/${PREZ_LITE_REPO}.git"
          else
            CLONE_URL="https://github.com/${PREZ_LITE_REPO}.git"
          fi

          git clone --depth 1 --filter=blob:none --sparse \
            -b "$PREZ_LITE_VERSION" \
            "$CLONE_URL" \
            .prez-lite-cache/repo

          cd .prez-lite-cache/repo
          git sparse-checkout set packages/data-processing web/app/utils
          cd ../..

          # Move data-processing to expected location
          mv .prez-lite-cache/repo/packages/data-processing .prez-lite-cache/data-processing

          # Copy shared utility into data-processing
          cp .prez-lite-cache/repo/web/app/utils/shacl-profile-parser.ts \
            .prez-lite-cache/data-processing/scripts/shacl-profile-parser.ts

          rm -rf .prez-lite-cache/repo

          # Patch: remove workspace dependency on @prez-lite/web
          cd .prez-lite-cache/data-processing
          jq 'del(.dependencies["@prez-lite/web"])' package.json > tmp.json && mv tmp.json package.json

          # Patch: rewrite import to use local copy
          sed -i 's|@prez-lite/web/utils/shacl-profile-parser|./shacl-profile-parser.ts|g' scripts/process-vocab.js

          echo "✓ Fetched data-processing from ${PREZ_LITE_REPO}@${PREZ_LITE_VERSION}"

      - name: Install data-processing dependencies
        run: |
          cd .prez-lite-cache/data-processing
          npm install

      - name: Process vocabularies
        run: |
          ARGS="--sourceDir data/vocabs --outputBase public/export/vocabs --systemDir public/export/system --pattern *.ttl"

          if [ -f "data/config/profiles.ttl" ]; then
            ARGS="$ARGS --profiles data/config/profiles.ttl"
          fi

          if [ -d "data/background" ]; then
            ARGS="$ARGS --backgroundDir data/background"
          fi

          node .prez-lite-cache/data-processing/scripts/process-vocab.js $ARGS
          echo "✓ Vocabularies processed"

      - name: Generate system metadata
        run: |
          mkdir -p public/export/system/vocabularies public/export/system/search

          # Vocabulary metadata index
          ARGS="--sourceDir data/vocabs --output public/export/system/vocabularies/index.json"
          if [ -d "data/background" ]; then
            ARGS="$ARGS --backgroundDir data/background"
          fi
          node .prez-lite-cache/data-processing/scripts/generate-vocab-metadata.js $ARGS || echo "⚠ Vocab metadata generation skipped"

          # Labels (only if background dir has TTL files)
          if ls data/background/*.ttl >/dev/null 2>&1; then
            node .prez-lite-cache/data-processing/scripts/generate-labels.js \
              --backgroundDir data/background \
              --output public/export/system/labels.json || echo "⚠ Labels generation skipped"
          fi

          # Search index
          node .prez-lite-cache/data-processing/scripts/generate-search-index.js \
            --exportDir public/export \
            --output public/export/system/search \
            --vocabMetadata public/export/system/vocabularies/index.json || echo "⚠ Search index generation skipped"

          echo "✓ System metadata generated"

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        env:
          GITHUB_TOKEN: ${{ secrets.prez-lite-token }}
          PREZ_LITE_VERSION: ${{ inputs.prez-lite-version }}
        run: pnpm install

      - name: Generate static site
        env:
          GITHUB_TOKEN: ${{ secrets.prez-lite-token }}
          PREZ_LITE_VERSION: ${{ inputs.prez-lite-version }}
        run: pnpm generate

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .output/public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
